# Architectural Decision Log

> Every architectural decision is logged here to prevent reversal and maintain consistency.
> Format: Decision, Reason, Consequence, Alternative Rejected

---

## ADR-001: Unified Trading Engine Architecture

**Date:** 2026-01-14
**Status:** Accepted

### Decision
Use a single `UnifiedTradingEngine` class as the central orchestrator for all trading operations, rather than separate engines per market type.

### Reason
- Simplifies state management across markets
- Enables consistent risk controls
- Reduces code duplication
- Easier to maintain and extend

### Consequence
- All market types (crypto, stocks, commodities) share the same execution flow
- Risk settings apply uniformly
- Single point of configuration

### Alternative Rejected
Separate engines per market (CryptoEngine, StockEngine, etc.) - rejected due to code duplication and inconsistent behavior.

---

## ADR-002: SQLite for State Persistence

**Date:** 2026-01-14
**Status:** Accepted

### Decision
Use SQLite databases for all persistent storage (trades, equity history, ML performance).

### Reason
- Zero external dependencies (no Redis, PostgreSQL setup)
- File-based, easy to backup
- Sufficient performance for trading volume
- Portable across environments

### Consequence
- No distributed state (single machine only)
- Must handle concurrent access carefully
- Backup via file copy

### Alternative Rejected
PostgreSQL - rejected due to setup complexity for a single-user trading system.

---

## ADR-003: Risk Controls as Kill Switches

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Risk control toggles (shorting, leverage, aggressive) act as "kill switches" that override AI recommendations.

### Reason
- User safety is paramount
- AI can recommend risky strategies, but user has final say
- Quick disable if something goes wrong
- Prevents runaway losses

### Consequence
- AI Strategy can suggest using leverage, but it won't execute if toggle is OFF
- Settings persist in `risk_settings.json`
- Dashboard shows toggle state prominently

### Alternative Rejected
AI-controlled risk settings - rejected because user must maintain control over risk exposure.

---

## ADR-004: Auto-Pause on Daily Limits

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Automatically pause trading when daily loss limit (-2%) is hit or when daily target (+1%) is achieved with 5+ trades.

### Reason
- Prevents emotional trading after losses
- Protects gains after successful day
- Enforces discipline automatically
- Sends alert so user knows

### Consequence
- Trading stops automatically (can be manually resumed)
- Telegram alert sent on pause
- Must wait for next day or manual resume

### Alternative Rejected
Manual-only pause - rejected because users may not react quickly enough to stop losses.

---

## ADR-005: ML Model Performance Tracking

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Track every ML prediction and its outcome in a dedicated SQLite database to measure model accuracy per market condition.

### Reason
- Identify which models work best in bull/bear/sideways markets
- Enable dynamic model selection
- Provide data for model improvement
- Accountability for AI decisions

### Consequence
- Every signal includes `prediction_id`
- Outcomes recorded when positions close
- API endpoints for viewing performance
- Storage grows over time (need periodic cleanup)

### Alternative Rejected
No tracking (trust models blindly) - rejected because we need data to improve and validate models.

---

## ADR-006: Strategy Backtesting Before Activation

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Require strategies generated by AI to pass a backtest on recent data before activation.

### Reason
- Prevents activation of losing strategies
- Tests strategy logic before real money
- Builds confidence in AI recommendations
- Provides expected performance metrics

### Consequence
- `activate_strategy()` requires `require_backtest=True` by default
- Backtest uses last 30 days of data
- Strategy must show positive expected return
- Can be bypassed with `require_backtest=False` if needed

### Alternative Rejected
Activate immediately - rejected due to risk of untested strategies causing losses.

---

## ADR-007: Telegram as Primary Alert Channel

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Use Telegram as the primary notification channel for trade alerts, with Discord as secondary option.

### Reason
- Telegram has reliable API
- Mobile notifications work well
- Easy bot setup
- Most traders already use it

### Consequence
- Requires `TELEGRAM_BOT_TOKEN` and `TELEGRAM_CHAT_ID`
- Falls back gracefully if not configured
- Alert types: trade executed, target achieved, loss limit, auto-pause

### Alternative Rejected
Email notifications - rejected due to slower delivery and worse mobile experience.

---

## ADR-008: AI Brain Pattern Learning from Historical Data

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Train the AI Brain's Pattern Learner on historical market data to learn which conditions lead to profitable trades.

### Reason
- Cold start problem: new system has no experience
- Historical data provides learning signal
- Can identify market condition patterns
- Improves decision quality over time

### Consequence
- Training script: `scripts/ml/train_ai_brain.py`
- Uses ccxt to fetch historical OHLCV
- Calculates indicators (RSI, SMA, volatility)
- Feeds to pattern learner with future returns

### Alternative Rejected
Learn only from live trades - rejected because it takes too long to accumulate sufficient data.

---

## ADR-009: Multi-Timeframe Analysis for Signal Confirmation

**Date:** 2026-01-14
**Status:** Accepted

### Decision
Use multi-timeframe (MTF) analysis to confirm or reject trading signals by checking higher timeframe trends.

### Reason
- Reduces false signals
- Aligns with larger market trend
- Common professional trading practice
- Improves win rate

### Consequence
- Signals checked against 4h and daily trends
- Counter-trend signals get confidence reduction
- Trend-aligned signals get confidence boost
- Can be disabled with `use_mtf_filter=False`

### Alternative Rejected
Single timeframe only - rejected because it misses important trend context.

---

## ADR-010: Feature Flags for Risky Features

**Date:** 2026-01-15
**Status:** Accepted

### Decision
Wrap all risky features (shorting, leverage, aggressive mode) in feature flags that can be toggled.

### Reason
- Safe rollout of new features
- Quick disable if issues found
- User control over risk exposure
- A/B testing capability

### Consequence
- Flags stored in `risk_settings.json`
- Controllable via dashboard toggles
- Default to safe values (false)
- API endpoints for reading/updating

### Alternative Rejected
Hardcoded features - rejected because it prevents safe experimentation.

---

## Template for New Decisions

```markdown
## ADR-XXX: [Title]

**Date:** YYYY-MM-DD
**Status:** Proposed | Accepted | Deprecated | Superseded

### Decision
[What is the change being proposed?]

### Reason
[Why is this change needed?]

### Consequence
[What are the implications?]

### Alternative Rejected
[What other options were considered and why rejected?]
```

---

*Last Updated: 2026-01-15*

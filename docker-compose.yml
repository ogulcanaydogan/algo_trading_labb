# =============================================================================
# Algo Trading Lab - Docker Compose Configuration
# =============================================================================
# Services:
# - orchestrator: Multi-market trading orchestrator
# - api: REST API and dashboard
# - monitor: System and trading monitoring
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Multi-market orchestrator - manages crypto, commodity, and stock bots
  # ---------------------------------------------------------------------------
  orchestrator:
    build:
      context: .
      args:
        BUILD_DATE: ${BUILD_DATE:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    container_name: algo-trading-orchestrator
    command: python scripts/trading/run_multi_market.py --all
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
    volumes:
      - ./:/app
      - trading_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/live_paper_trading/state.json') else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - trading_network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # API & Dashboard
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
    container_name: algo-trading-api
    command: uvicorn api.api:app --host 0.0.0.0 --port 8000
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
    volumes:
      - ./:/app
      - trading_data:/app/data
    ports:
      - "8000:8000"
    restart: unless-stopped
    depends_on:
      orchestrator:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - trading_network
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # System Monitor (optional - for production monitoring)
  # ---------------------------------------------------------------------------
  monitor:
    build:
      context: .
    container_name: algo-trading-monitor
    command: python -c "from bot.monitoring import MonitoringService; s = MonitoringService(); s.start(); import time; time.sleep(999999)"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
    volumes:
      - ./:/app
      - trading_data:/app/data
    restart: unless-stopped
    profiles:
      - monitoring
    networks:
      - trading_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Auto optimizer (optional - runs periodic strategy optimization)
  # ---------------------------------------------------------------------------
  optimizer:
    build:
      context: .
    container_name: algo-trading-optimizer
    command: python scripts/tools/run_auto_optimize.py
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    volumes:
      - ./:/app
      - trading_data:/app/data
    restart: unless-stopped
    profiles:
      - optimization
    networks:
      - trading_network
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

# =============================================================================
# Networks
# =============================================================================
networks:
  trading_network:
    driver: bridge
    name: algo_trading_network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  trading_data:
    driver: local
    name: algo_trading_data
